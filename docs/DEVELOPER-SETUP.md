# Developer Setup Guide

This guide helps RPS team developers set up their isolated development environment.

## Overview

Multiple developers can deploy to the same AWS account using **prefix-based isolation**. Each developer gets their own set of resources that don't interfere with others.

---

## Quick Start

### 1. Choose Your Prefix

Your prefix should be unique and identify your resources:

- Use your first name: `alice`, `bob`, `charlie`
- Use your initials: `jd` (John Doe)
- Use a ticket number: `ticket-123`

**Example:** If your name is Alice, use `PREFIX=alice`

### 2. Set Environment Variables

```bash
# Option 1: Export for your session
export PREFIX=alice
export ACCOUNT_CORE_ID=111111111111
export ACCOUNT_RPS_ID=222222222222
export REGION=eu-west-1

# Option 2: Create a .env file
cp .env.example .env
# Edit .env with your prefix
source .env
```

### 3. Deploy Your Stack

```bash
# Deploy RPS stack (you own this)
cdk deploy ${PREFIX}-StackRps --profile rps-account

# Verify deployment
aws cloudformation describe-stacks \
  --stack-name ${PREFIX}-rps-stack \
  --region ${REGION} \
  --profile rps-account
```

### 4. Coordinate with Core Team

The Core team needs to deploy their stack with the same prefix:

```bash
# Core team deploys (they do this)
cdk deploy ${PREFIX}-StackCore --profile core-account
```

**Important:** Give the Core team your prefix so they can deploy the resources you depend on.

---

## Your Resources

With `PREFIX=alice`, you'll have:

### RPS Account (You Own These)

- **Lambda:** `alice-s3-processor`
- **IAM Role:** `alice-processor-lambda-role` ⚠️ Name must match exactly
- **SQS Queue:** `alice-processor-queue`
- **DLQ:** `alice-processor-dlq`
- **EventBridge Rule:** `alice-receive-s3-events`
- **CloudFormation Stack:** `alice-rps-stack`

### Core Account (Core Team Owns These)

- **S3 Bucket:** `alice-core-test-bucket-111111111111-eu-west-1`
- **EventBridge Rule:** `alice-s3-input-events`
- **KMS Key:** (generated by CloudFormation)
- **CloudFormation Stack:** `alice-core-stack`

---

## Development Workflow

### 1. Make Code Changes

Edit the RPS stack or Lambda code:

```bash
# Edit Lambda processor
vim lambda/processor.ts

# Edit RPS stack
vim src/stack-rps.ts
```

### 2. Build

```bash
npm run build
```

### 3. Preview Changes

```bash
cdk diff ${PREFIX}-StackRps --profile rps-account
```

### 4. Deploy

```bash
cdk deploy ${PREFIX}-StackRps --profile rps-account
```

### 5. Test

```bash
# Upload test file
aws s3 cp test-data/sample-input.txt \
  s3://${PREFIX}-core-test-bucket-${ACCOUNT_CORE_ID}-${REGION}/input/test-$(date +%s).txt \
  --profile core-account

# Check output (after ~30 seconds)
aws s3 ls s3://${PREFIX}-core-test-bucket-${ACCOUNT_CORE_ID}-${REGION}/output/ \
  --profile core-account

# Check Lambda logs
aws logs tail /aws/lambda/${PREFIX}-s3-processor --follow --profile rps-account
```

---

## Common Tasks

### View Your Lambda Logs

```bash
aws logs tail /aws/lambda/${PREFIX}-s3-processor \
  --follow \
  --region ${REGION} \
  --profile rps-account
```

### Check SQS Queue Status

```bash
QUEUE_URL="https://sqs.${REGION}.amazonaws.com/${ACCOUNT_RPS_ID}/${PREFIX}-processor-queue"

aws sqs get-queue-attributes \
  --queue-url ${QUEUE_URL} \
  --attribute-names All \
  --region ${REGION} \
  --profile rps-account
```

### Invoke Lambda Manually

```bash
# Create test event
cat > /tmp/test.json <<EOF
{
  "Records": [{
    "body": "{\"detail\":{\"bucket\":{\"name\":\"${PREFIX}-core-test-bucket-${ACCOUNT_CORE_ID}-${REGION}\"},\"object\":{\"key\":\"input/test.txt\"}}}"
  }]
}
EOF

# Invoke
aws lambda invoke \
  --function-name ${PREFIX}-s3-processor \
  --payload file:///tmp/test.json \
  --region ${REGION} \
  --profile rps-account \
  /tmp/response.json

cat /tmp/response.json
```

### Update Lambda Code Only

```bash
# Build
npm run build

# Update function code (faster than full stack deploy)
aws lambda update-function-code \
  --function-name ${PREFIX}-s3-processor \
  --zip-file fileb://cdk.out/asset.XXX/index.zip \
  --region ${REGION} \
  --profile rps-account
```

---

## Troubleshooting

### Error: Stack Already Exists

Someone else is using your prefix. Choose a different one:

```bash
export PREFIX=alice2
cdk deploy ${PREFIX}-StackRps --profile rps-account
```

### Error: Lambda Can't Access S3

1. Verify Core team deployed their stack with your prefix
2. Check IAM role name is exactly `${PREFIX}-processor-lambda-role`
3. Check Core S3 bucket policy allows your Lambda role

```bash
# Check your Lambda role
aws iam get-role \
  --role-name ${PREFIX}-processor-lambda-role \
  --region ${REGION} \
  --profile rps-account

# Check Core bucket policy (Core account)
aws s3api get-bucket-policy \
  --bucket ${PREFIX}-core-test-bucket-${ACCOUNT_CORE_ID}-${REGION} \
  --profile core-account
```

### Error: No Events Received

1. Check Core EventBridge rule exists:
```bash
aws events describe-rule \
  --name ${PREFIX}-s3-input-events \
  --region ${REGION} \
  --profile core-account
```

2. Check RPS event bus policy:
```bash
aws events describe-event-bus \
  --name default \
  --region ${REGION} \
  --profile rps-account
```

---

## Cleanup

When you're done testing, destroy your stack:

```bash
# Destroy RPS stack (you own this)
cdk destroy ${PREFIX}-StackRps --profile rps-account

# Ask Core team to destroy their stack
# cdk destroy ${PREFIX}-StackCore --profile core-account
```

**Note:** Always destroy RPS stack before Core stack (dependency order).

---

## Best Practices

### DO ✅

- Use a unique prefix for your resources
- Test in your own isolated environment before merging
- Clean up resources when done testing
- Communicate with Core team about your prefix
- Follow the naming conventions in RESOURCE-CONTRACT.md

### DON'T ❌

- Use `dev`, `staging`, `prod` as your prefix (reserved for shared environments)
- Deploy without setting PREFIX (defaults to `dev` - conflicts with others)
- Modify Core team's resources directly
- Change the Lambda role name (breaks Core bucket policy)
- Deploy to production accounts without approval

---

## CI/CD Integration

For automated deployments:

```yaml
# .github/workflows/deploy.yml example
name: Deploy RPS Stack

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: arn:aws:iam::222222222222:role/github-actions
          aws-region: eu-west-1

      - name: Deploy
        env:
          PREFIX: ${{ github.actor }}  # Use GitHub username as prefix
          ACCOUNT_CORE_ID: 111111111111
          ACCOUNT_RPS_ID: 222222222222
          REGION: eu-west-1
        run: |
          npm ci
          npm run build
          npx cdk deploy ${PREFIX}-StackRps --require-approval never
```

---

## Team Coordination

### Shared Environments

For team-shared environments, coordinate deployments:

| Prefix | Owner | Purpose | Who Can Deploy |
|--------|-------|---------|----------------|
| `dev` | Team | Shared development | Any team member |
| `staging` | Tech Lead | Pre-production testing | Tech lead only |
| `prod` | DevOps | Production | Automated only |

### Resource Discovery

If you need to find another developer's resources:

```bash
# List all Lambda functions with prefix pattern
aws lambda list-functions \
  --region ${REGION} \
  --profile rps-account \
  --query "Functions[?starts_with(FunctionName, 'alice-')].[FunctionName]" \
  --output table

# List all SQS queues
aws sqs list-queues \
  --queue-name-prefix alice- \
  --region ${REGION} \
  --profile rps-account
```

---

## Getting Help

- **Resource contract questions:** See RESOURCE-CONTRACT.md
- **Debugging:** See DEBUGGING.md
- **Testing:** See TESTING.md
- **Team channel:** [Your team Slack/Teams channel]
- **On-call:** [On-call rotation]
